@page "/"
@inject AgentRegistry Registry
@implements IDisposable

<PageTitle>@L["PageTitle_Dashboard"]</PageTitle>

<h2 class="mb-4">Dashboard</h2>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card p-3 text-center">
            <h1 class="display-4">@_agents.Count</h1>
            <p class="text-muted">@L["Dashboard_RegisteredAgents"]</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 text-center">
            <h1 class="display-4 text-success">@_agents.Count(a => a.IsConnected)</h1>
            <p class="text-muted">@L["Dashboard_Connected"]</p>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 text-center">
            <h1 class="display-4 text-danger">@_agents.Count(a => !a.IsConnected)</h1>
            <p class="text-muted">@L["Status_Offline"]</p>
        </div>
    </div>
</div>

<div class="card p-3">
    <table class="table table-dark table-hover mb-0">
        <thead>
            <tr>
                <th>@L["Field_Name"]</th><th>@L["Field_Host"]</th><th>@L["Field_Group"]</th><th>@L["Field_Tags"]</th><th>@L["Field_Status"]</th><th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var agent in _agents)
            {
                <tr>
                    <td>@agent.Info.Name</td>
                    <td>@agent.Info.Host:@agent.Info.Port</td>
                    <td>@agent.Info.Group</td>
                    <td>@string.Join(", ", agent.Info.Tags)</td>
                    <td>
                        <span class="badge @(agent.IsConnected ? "badge-online" : "badge-offline")">
                            @(agent.IsConnected ? L["Status_Online"].Value : L["Status_Offline"].Value)
                        </span>
                    </td>
                    <td>
                        <a href="/agents/@agent.Info.Name" class="btn btn-sm btn-outline-light">@L["Btn_Detail"]</a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private IReadOnlyCollection<AgentClient> _agents = Array.Empty<AgentClient>();
    private System.Timers.Timer?             _timer;

    protected override void OnInitialized()
    {
        _agents = Registry.All;

        _timer = new System.Timers.Timer(TimeSpan.FromSeconds(3));
        _timer.Elapsed += async (_, _) => await InvokeAsync(StateHasChanged);
        _timer.Start();
    }

    public void Dispose() => _timer?.Dispose();
}
