@page "/agents"
@inject AgentRegistry Registry
@implements IDisposable

<PageTitle>@L["PageTitle_Agents"]</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Agents</h2>
</div>

@* 그룹 탭 *@
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <button class="nav-link @(_selectedGroup == null ? "active" : "")"
                @onclick="() => SelectGroup(null)">
            @L["Btn_All"] <span class="badge bg-secondary ms-1">@_agents.Count</span>
        </button>
    </li>
    @foreach (var group in _groups)
    {
        var g = group;
        var count = _agents.Count(a => a.Info.Group == g);
        <li class="nav-item">
            <button class="nav-link @(_selectedGroup == g ? "active" : "")"
                    @onclick="() => SelectGroup(g)">
                @g <span class="badge bg-secondary ms-1">@count</span>
            </button>
        </li>
    }
</ul>

@* 검색 + 태그 필터 *@
<div class="card p-3 mb-3">
    <div class="mb-2">
        <input class="form-control bg-dark text-white border-secondary"
               placeholder="@L["Agents_SearchPlaceholder"]"
               @bind="_searchText" @bind:event="oninput" />
    </div>
    @if (_allTags.Count > 0)
    {
        <div class="d-flex flex-wrap gap-1">
            @foreach (var tag in _allTags)
            {
                var t = tag;
                var active = _selectedTags.Contains(t);
                <button class="btn btn-sm @(active ? "btn-info" : "btn-outline-info")"
                        @onclick="() => ToggleTag(t)">
                    #@t
                </button>
            }
            @if (_selectedTags.Count > 0)
            {
                <button class="btn btn-sm btn-outline-secondary" @onclick="ClearTags">@L["Btn_Reset"]</button>
            }
        </div>
    }
</div>

@* Agent 테이블 *@
<div class="card p-3">
    <table class="table table-dark table-hover mb-0">
        <thead>
            <tr>
                <th>@L["Field_Name"]</th>
                <th>@L["Field_Description"]</th>
                <th>@L["Field_Host"]</th>
                <th>@L["Field_Group"]</th>
                <th>@L["Field_Tags"]</th>
                <th>@L["Field_Status"]</th>
                <th>CPU</th>
                <th>RAM</th>
                <th>@L["Field_Actions"]</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var agent in Filtered)
            {
                var res = agent.LastResource;
                <tr>
                    <td><strong>@agent.Info.Name</strong></td>
                    <td>@agent.Info.Description</td>
                    <td>@agent.Info.Host:@agent.Info.Port</td>
                    <td>@agent.Info.Group</td>
                    <td>
                        @foreach (var tag in agent.Info.Tags)
                        {
                            <span class="badge bg-info text-dark me-1">#@tag</span>
                        }
                    </td>
                    <td>
                        @{
                            var since = agent.LastHeartbeatAt.HasValue
                                ? $"{(int)(DateTime.UtcNow - agent.LastHeartbeatAt.Value).TotalSeconds}s ago"
                                : "-";
                        }
                        <span class="badge @(agent.IsConnected ? "badge-online" : "badge-offline")"
                              title="@L["Agents_LastHeartbeat"]: @since">
                            @(agent.IsConnected ? L["Status_Online"].Value : L["Status_Offline"].Value)
                        </span>
                    </td>
                    <td class="text-nowrap">
                        @if (res != null)
                        {
                            <span>@res.CpuPct.ToString("0.0")%</span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td class="text-nowrap">
                        @if (res != null)
                        {
                            <span>@res.MemUsedMb / @res.MemTotalMb MB</span>
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                    <td>
                        <a href="/agents/@agent.Info.Name" class="btn btn-sm btn-outline-info">@L["Btn_Detail"]</a>
                        <a href="/agents/@agent.Info.Name/config" class="btn btn-sm btn-outline-warning">@L["Btn_Config"]</a>
                        <a href="/agents/@agent.Info.Name/log" class="btn btn-sm btn-outline-secondary">@L["Btn_Log"]</a>
                        <a href="/commands/@agent.Info.Name" class="btn btn-sm btn-outline-success">@L["Btn_Command"]</a>
                    </td>
                </tr>
            }
            @if (!Filtered.Any())
            {
                <tr><td colspan="9" class="text-center text-muted py-3">@L["Agents_NoResults"]</td></tr>
            }
        </tbody>
    </table>
</div>

@code {
    private IReadOnlyCollection<AgentClient> _agents       = Array.Empty<AgentClient>();
    private List<string>                     _groups       = new();
    private List<string>                     _allTags      = new();
    private HashSet<string>                  _selectedTags = new();
    private string?                          _selectedGroup;
    private string                           _searchText   = "";
    private System.Timers.Timer?             _timer;

    private IEnumerable<AgentClient> Filtered =>
        _agents
            .Where(a => _selectedGroup == null || a.Info.Group == _selectedGroup)
            .Where(a => string.IsNullOrEmpty(_searchText) ||
                        a.Info.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                        a.Info.Description.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                        a.Info.Host.Contains(_searchText, StringComparison.OrdinalIgnoreCase))
            .Where(a => _selectedTags.Count == 0 || _selectedTags.All(t => a.Info.Tags.Contains(t)));

    protected override void OnInitialized()
    {
        _agents  = Registry.All;
        _groups  = _agents.Select(a => a.Info.Group).Where(g => !string.IsNullOrEmpty(g)).Distinct().Order().ToList();
        _allTags = _agents.SelectMany(a => a.Info.Tags).Distinct().Order().ToList();

        // 하트비트 캐시를 3초마다 UI에 반영
        _timer = new System.Timers.Timer(TimeSpan.FromSeconds(3));
        _timer.Elapsed += async (_, _) => await InvokeAsync(StateHasChanged);
        _timer.Start();
    }

    private void SelectGroup(string? group) => _selectedGroup = group;

    private void ToggleTag(string tag)
    {
        if (!_selectedTags.Remove(tag))
            _selectedTags.Add(tag);
    }

    private void ClearTags() => _selectedTags.Clear();

    public void Dispose() => _timer?.Dispose();
}
