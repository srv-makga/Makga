@page "/agents/{Name}/config"
@inject AgentRegistry Registry

<PageTitle>@string.Format(L["PageTitle_Config"], Name)</PageTitle>

<h2>@Name â€” @L["Btn_Config"]</h2>

@if (_notFound)
{
    <div class="alert alert-danger">@string.Format(L["Agent_NotFound"], Name)</div>
}
else
{
    <div class="card p-3">
        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="alert alert-success">@_message</div>
        }
        <div class="mb-3">
            <label class="form-label">appsettings.json</label>
            <textarea class="form-control bg-dark text-white font-monospace"
                      rows="20"
                      @bind="_configJson"></textarea>
        </div>
        <button class="btn btn-warning" @onclick="SaveAsync" disabled="@_saving">
            @(_saving ? L["Btn_Saving"].Value : L["Btn_Save"].Value)
        </button>
        <a href="/agents/@Name" class="btn btn-outline-light ms-2">@L["Btn_Cancel"]</a>
    </div>
}

@code {
    [Parameter] public string Name { get; set; } = "";

    private AgentClient? _client;
    private bool         _notFound;
    private string       _configJson = "{}";
    private string       _message    = "";
    private bool         _saving;

    protected override async Task OnInitializedAsync()
    {
        _client = Registry.Get(Name);
        if (null == _client)
        {
            _notFound = true;
            return;
        }

        var resp = await _client.SendEmptyAsync(PacketId.GetConfig);
        if (resp.HasValue)
        {
            var data = PacketSerializer.Deserialize<ConfigDataResponse>(resp.Value.payload);
            _configJson = data?.Json ?? "{}";
        }
    }

    private async Task SaveAsync()
    {
        if (null == _client) return;
        _saving  = true;
        _message = "";

        var changes = new Dictionary<string, string> { { "_raw", _configJson } };
        await _client.SendAsync(PacketId.SetConfig, new SetConfigRequest { Changes = changes });

        _message = L["Config_SaveDone"];
        _saving  = false;
    }
}
